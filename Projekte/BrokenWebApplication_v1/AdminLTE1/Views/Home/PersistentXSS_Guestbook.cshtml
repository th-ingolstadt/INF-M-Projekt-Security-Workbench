@using WebMatrix.Data
@using System.Data.SqlClient

@{
    ViewBag.Title = "Persistent/ Stored Cross-Site-Scripting";
    ViewBag.Description = "Tutorial";

    var db = Database.Open("Database1");
    var selectQueryString = "SELECT * FROM Guestbook";

    var guestbookentry = Request.Form["guestbookentry"];

    var entryString = Request.Unvalidated("guestbookentry"); // Validation bypassed
    if(entryString != null && entryString != "")
    {
        
        var name = "Mr.Robot";
        var currentDate = DateTime.Now;
        var insertQuery = "INSERT INTO Guestbook (username, date, comment) " +
        "VALUES (@0, @1, @2)";
        db.Execute(insertQuery, name, currentDate, entryString);
    }
}

<script src="~/Scripts/js/guestbook.js" type="text/javascript"></script>
<script src="~/Content/js/plugins/jquery/jquery-2.2.4.min.js"></script>
<style>
    .modal-header, h4, .close {
        background-color: #5cb85c;
        color: white !important;
        text-align: center;
        font-size: 30px;
    }

    .modal-footer {
        background-color: #f9f9f9;
    }
</style>
<script>
    $(document).ready(function () {
        $("#letsGo").click(function () {
            $("#loginModal").modal();
        });
        /*
        $("#loginButton").click(function () {
            var username = $("#usrname").val();
            var password = $("#pwd").val(); 

            if (username === "Mr.Robot" && password === "hallo123") {
                $("#loginModal").modal().toggle(); 
                alert("login success");
            } else {
                alert("Wrong Login credentials");
                $("#loginModal").modal();
            }
        });
        */
    });

</script>

<body onload="checkCookiesForLoggedinUser();">
    <!-- Modal -->
    <div class="modal fade" id="loginModal" role="dialog">
        <div class="modal-dialog">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header" style="padding:35px 50px;">
                    <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h4><span class="glyphicon glyphicon-lock"></span> Login</h4>
                </div>
                <div class="modal-body" style="padding:40px 50px;">
                    <form role="form">
                        <div class="form-group">
                            <label for="usrname"><span class="glyphicon glyphicon-user"></span> Username</label>
                            <input type="text" class="form-control" name="usrname" id="usrname" placeholder="Enter email">
                        </div>
                        <div class="form-group">
                            <label for="pwd"><span class="glyphicon glyphicon-eye-open"></span> Password</label>
                            <input type="text" class="form-control" id="pwd" name="pwd" placeholder="Enter password">
                        </div>
                        <div class="checkbox">
                            <label><input type="checkbox" value="" checked>Remember me</label>
                        </div>
                        <button class="btn btn-success" id="loginButton" onclick="checkLoginInput();"><span class="glyphicon glyphicon-off"></span> Login</button>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-danger btn-default pull-left" data-dismiss="modal"><span class="glyphicon glyphicon-remove"></span> Cancel</button>
                    <p>Not a member? <a href="#">Sign Up</a></p>
                    <p>Forgot <a href="#">Password?</a></p>
                </div>
            </div>

        </div>
    </div>

    <div class="row">
        <div class="col-xs-8 col-md-8">
            <div class="box box-default">
                <div class="box-header">
                    <h3 class="box-title">Aufgabenstellung</h3>
                </div>
                <div class="box-body">
                    <blockquote>
                        <p>
                            Die vorliegende Webseite entspricht einem Gästebuch, an dem der Anwender einen Eintrag hinterlassen kann.
                            Finden Sie an dieser Stelle die Sicherheitslücke und nutzen sie diese aus!
                            <br />
                            <button type="button" class="btn btn-primary" id="letsGo">Los Geht's</button>

                        </p>
                    </blockquote>
                </div>
            </div>

            <div class="box box-default" id="guestbook" hidden>
                <div class="box-header">
                    <h3 class="box-title">Aufgabe</h3>
                </div>
                <div class="box-body">
                    <!--<FORM ENCTYPE="text/plain" NAME="mail" METHOD='GET' onSubmit="return submitForms()">-->
                        <form role="form">
                            <div class="form-group">
                                <label for="guestbookEntry">Hinterlasse eine Eintrag in Mr. Robots Gästebuch</label>
                                <textarea class="form-control" id="guestbookentry" name="guestbookentry" value="@guestbookentry" rows="4"></textarea>
                            </div>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </form>
                        <br /><br />
                        <h3>Mr. Robots Gästebuch</h3>
                        <table class="table table-striped" id="guestbook">
                            <thead>
                                <tr>
                                    <th>Username</th>
                                    <th>Datum</th>
                                    <th>Eintrag</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var row in db.Query(selectQueryString))
                                {
                                    <tr>
                                        <td>@row.username</td>
                                        <td>@row.date</td>
                                        <td>@row.comment</td>
                                    </tr>
                                }

                            </tbody>
                        </table>
                </div>
            </div>
        </div>
    </div>

</body>
